{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Dashboard Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div>
            <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">Student Performance Dashboard</h2>
            <p class="text-gray-400">Analyze and predict student performance with AI-powered insights</p>
        </div>
        <div class="mt-4 md:mt-0 flex space-x-2">
            <button class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-download mr-2"></i> Export Data
            </button>
            <button class="bg-gradient-to-r from-purple-600 to-purple-800 hover:from-purple-700 hover:to-purple-900 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-cog mr-2"></i> Settings
            </button>
        </div>
    </div>

    <!-- Upload Data Section -->
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 hover:border-green-500 transition-all duration-300 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-green-300">Upload Training Data</h3>
            <span class="text-sm text-gray-400">Supported format: .xlsx</span>
        </div>
        <form method="post" enctype="multipart/form-data" action="{% url 'dashboard:upload_data' %}" class="flex items-center space-x-4" id="uploadForm">
            {% csrf_token %}
            <div class="flex-1">
                <input type="file" 
                       name="excel_file" 
                       accept=".xlsx,.xls"
                       class="w-full p-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-green-500 focus:ring-2 focus:ring-green-800 transition-all duration-300"
                       required>
            </div>
            <button type="submit" id="uploadBtn"
                    class="bg-gradient-to-r from-green-600 to-green-800 hover:from-green-700 hover:to-green-900 text-white font-medium py-2 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center space-x-2">
                <i class="fas fa-upload"></i>
                <span>Upload & Train</span>
            </button>
        </form>
    </div>

    <!-- Training Status Modal -->
    <div id="trainingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 max-w-md w-full mx-4">
            <div id="trainingStatus" class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-green-500 border-t-transparent mb-4"></div>
                <h3 class="text-xl font-semibold text-white mb-2">Training Model</h3>
                <p class="text-gray-400">Please wait while the model is being trained...</p>
            </div>
            <div id="completionStatus" class="flex flex-col items-center hidden">
                <div class="text-green-500 text-5xl mb-4">âœ“</div>
                <h3 class="text-xl font-semibold text-white mb-2">Training Complete</h3>
                <p class="text-gray-400 mb-4">Model is now ready for predictions!</p>
                <button onclick="closeModal()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg transition duration-300">
                    Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Total Students Card -->
        <div class="bg-gradient-to-br from-blue-900 to-blue-800 p-6 rounded-xl shadow-lg border border-blue-800 hover:border-blue-500 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-blue-300 text-sm font-medium">Total Students</p>
                    <h3 class="text-2xl font-bold text-white mt-2">{{ students|length }}</h3>
                </div>
                <div class="bg-blue-700 p-3 rounded-lg">
                    <i class="fas fa-users text-blue-300"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm text-blue-300">
                <i class="fas fa-chart-bar mr-1"></i> Active Students
            </div>
        </div>

        <!-- Average Performance Card -->
        <div class="bg-gradient-to-br from-purple-900 to-purple-800 p-6 rounded-xl shadow-lg border border-purple-800 hover:border-purple-500 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-purple-300 text-sm font-medium">Class Performance</p>
                    <h3 class="text-2xl font-bold text-white mt-2">
                        {% if avg_performance %}{{ avg_performance|floatformat:1 }}%{% else %}0%{% endif %}
                    </h3>
                </div>
                <div class="bg-purple-700 p-3 rounded-lg">
                    <i class="fas fa-chart-line text-purple-300"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm text-purple-300">
                <i class="fas fa-arrow-{% if performance_trend == 'up' %}up text-green-400{% else %}down text-red-400{% endif %} mr-1"></i>
                {{ trend_percentage|default:0 }}% from last month
            </div>
        </div>

        <!-- At Risk Students Card -->
        <div class="bg-gradient-to-br from-red-900 to-red-800 p-6 rounded-xl shadow-lg border border-red-800 hover:border-red-500 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-red-300 text-sm font-medium">At Risk Students</p>
                    <h3 class="text-2xl font-bold text-white mt-2">{{ at_risk_count }}</h3>
                </div>
                <div class="bg-red-700 p-3 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-red-300"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm text-red-300">
                <i class="fas fa-user-shield mr-1"></i>
                Need Attention
            </div>
        </div>

        <!-- Average Attendance Card -->
        <div class="bg-gradient-to-br from-indigo-900 to-indigo-800 p-6 rounded-xl shadow-lg border border-indigo-800 hover:border-indigo-500 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-indigo-300 text-sm font-medium">Class Attendance</p>
                    <h3 class="text-2xl font-bold text-white mt-2">
                        {% if avg_attendance %}{{ avg_attendance|floatformat:1 }}%{% else %}0%{% endif %}
                    </h3>
                </div>
                <div class="bg-indigo-700 p-3 rounded-lg">
                    <i class="fas fa-calendar-check text-indigo-300"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm text-indigo-300">
                <i class="fas fa-arrow-{% if attendance_trend == 'up' %}up text-green-400{% else %}down text-red-400{% endif %} mr-1"></i>
                {{ attendance_percentage|default:0 }}% from last month
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Prediction Form -->
        <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 hover:border-blue-500 transition-all duration-300">
            <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-300 mb-4">Performance Prediction</h3>
            <form method="post" action="{% url 'dashboard:predict' %}" class="space-y-4" id="predictionForm">
                {% csrf_token %}
                <div>
                    <label for="student_id" class="block text-gray-400 mb-2">Select Student</label>
                    <select name="student_id" id="student_id" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-800 transition-all duration-300" required>
                        <option value="" disabled selected>Select a student</option>
                        {% for student in students %}
                        <option value="{{ student.id }}">{{ student.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="model_type" class="block text-gray-400 mb-2">Prediction Model</label>
                    <select name="model_type" id="model_type" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-800 transition-all duration-300">
                        <option value="random_forest">Random Forest (Default)</option>
                        <option value="neural_net">Neural Network</option>
                        <option value="gradient_boost">Gradient Boost</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-[1.02] flex items-center justify-center">
                    <i class="fas fa-chart-line mr-2"></i> Predict Performance
                </button>
            </form>
            
            <!-- Prediction Result Card -->
            <div id="predictionResultCard" class="mt-6 bg-gray-700 p-6 rounded-lg hidden animate__animated animate__fadeIn">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h4 class="text-lg font-medium text-white" id="selectedStudentName">Student Name</h4>
                        <p class="text-sm text-gray-400">Predicted Performance</p>
                    </div>
                    <div class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400" id="predictedScore">
                        0%
                    </div>
                </div>
                
                <div class="relative pt-1 mb-4">
                    <div class="flex mb-2 items-center justify-between">
                        <div class="text-xs text-gray-400">Progress</div>
                        <div class="text-right">
                            <span id="accuracyScore" class="text-xs font-semibold inline-block text-blue-400">
                                Accuracy: 95%
                            </span>
                        </div>
                    </div>
                    <div class="overflow-hidden h-2 text-xs flex rounded-full bg-gray-600">
                        <div id="predictionProgress" 
                             class="transition-all duration-500 ease-out shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-blue-500 to-purple-500"
                             style="width: 0%">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-gray-600 p-2 rounded">
                        <p class="text-xs text-gray-400">Attendance</p>
                        <p class="font-bold text-white" id="attendanceScore">0%</p>
                    </div>
                    <div class="bg-gray-600 p-2 rounded">
                        <p class="text-xs text-gray-400">Assignments</p>
                        <p class="font-bold text-white" id="assignmentScore">0%</p>
                    </div>
                    <div class="bg-gray-600 p-2 rounded">
                        <p class="text-xs text-gray-400">Test Scores</p>
                        <p class="font-bold text-white" id="testScore">0%</p>
                    </div>
                </div>
            </div>

            <!-- Recent Predictions -->
            <div class="mt-6">
                <h4 class="text-gray-400 font-medium mb-3">Recent Predictions</h4>
                <div class="space-y-3">
                    {% for prediction in recent_predictions|slice:":3" %}
                    <div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="text-white font-medium">{{ prediction.student.name }}</p>
                            <p class="text-xs text-gray-400">{{ prediction.timestamp|date:"M d, Y H:i" }}</p>
                        </div>
                        <div class="bg-{% if prediction.score >= 75 %}green{% elif prediction.score >= 50 %}yellow{% else %}red{% endif %}-900 text-{% if prediction.score >= 75 %}green{% elif prediction.score >= 50 %}yellow{% else %}red{% endif %}-300 px-3 py-1 rounded-full text-sm font-bold">
                            {{ prediction.score|floatformat:0 }}%
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 text-sm">No recent predictions</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Performance Visualization -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Performance Comparison Chart -->
            <div id="comparisonChartContainer" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 hidden animate__animated animate__fadeIn">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-purple-300">Performance Comparison</h3>
                    <div class="flex space-x-2">
                        <button id="radarViewBtn" class="bg-purple-700 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200">
                            <i class="fas fa-chart-pie mr-1"></i> Radar
                        </button>
                        <button id="barViewBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200">
                            <i class="fas fa-chart-bar mr-1"></i> Bar
                        </button>
                    </div>
                </div>
                <div class="h-96">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <!-- Performance Trends Chart -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-300 mb-4">Performance Trends</h3>
                <div class="h-72">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Performance Matrix -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-300 mb-4">Performance Matrix</h3>
                <div class="h-72">
                    <canvas id="matrixChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Table -->
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 hover:border-teal-500 transition-all duration-300">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-teal-300">Student Performance Data</h3>
            <div class="flex space-x-2">
                <div class="relative">
                    <input type="text" placeholder="Search students..." class="bg-gray-700 text-white pl-10 pr-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 w-64">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <button class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded-lg transition-all duration-300">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
        </div>
        
        {% if students %}
        <div class="overflow-x-auto">
            <table class="w-full text-left text-gray-400 border-collapse">
                <thead>
                    <tr class="bg-gray-700">
                        <th>Roll No</th>
                        <th>Name</th>
                        <th>Year</th>
                        <th>Participation</th>
                        <th>Assignments</th>
                        <th>Test Scores</th>
                        <th>Attendance</th>
                        <th>Final Grade</th>
                        <th>Predicted</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr class="hover:bg-gray-700 transition duration-300">
                        <td class="p-3 border-b border-gray-700">{{ student.roll_no }}</td>
                        <td class="p-3 border-b border-gray-700">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold mr-3">
                                    {{ student.name|first|upper }}
                                </div>
                                <span class="font-medium text-white">{{ student.name }}</span>
                            </div>
                        </td>
                        <td class="p-3 border-b border-gray-700">{{ student.year_of_study }}</td>
                        <td class="p-3 border-b border-gray-700">{{ student.participation }}%</td>
                        <td class="p-3 border-b border-gray-700">{{ student.assignments }}%</td>
                        <td class="p-3 border-b border-gray-700">{{ student.test_scores }}%</td>
                        <td class="p-3 border-b border-gray-700">
                            <div class="flex items-center">
                                <div class="w-16 bg-gray-600 rounded-full h-2 mr-2">
                                    <div class="bg-{% if student.attendance >= 80 %}green{% elif student.attendance >= 60 %}yellow{% else %}red{% endif %}-500 h-2 rounded-full" 
                                         style="width: {{ student.attendance }}%"></div>
                                </div>
                                {{ student.attendance }}%
                            </div>
                        </td>
                        <td class="p-3 border-b border-gray-700">
                            <span class="px-3 py-1 rounded-full text-sm font-bold 
                                {% if student.final_grade >= 75 %}bg-green-900 text-green-300
                                {% elif student.final_grade >= 60 %}bg-yellow-900 text-yellow-300
                                {% else %}bg-red-900 text-red-300{% endif %}">
                                {{ student.final_grade|floatformat:0 }}%
                            </span>
                        </td>
                        <td class="p-3 border-b border-gray-700">
                            <span class="px-3 py-1 rounded-full text-sm font-bold 
                                {% if student.performance_prediction >= 75 %}bg-green-900 text-green-300
                                {% elif student.performance_prediction >= 60 %}bg-yellow-900 text-yellow-300
                                {% else %}bg-red-900 text-red-300{% endif %}">
                                {{ student.performance_prediction|default:"N/A"|floatformat:0 }}%
                            </span>
                        </td>
                        <td class="p-3 border-b border-gray-700">
                            {% with risk_score=student.get_risk_score %}
                            <span class="px-3 py-1 rounded-full text-sm font-bold
                                {% if risk_score >= 75 %}bg-green-900 text-green-300
                                {% elif risk_score >= 60 %}bg-yellow-900 text-yellow-300
                                {% else %}bg-red-900 text-red-300{% endif %}">
                                {% if risk_score >= 75 %}Good Standing
                                {% elif risk_score >= 60 %}Needs Attention
                                {% else %}At Risk{% endif %}
                            </span>
                            {% endwith %}
                        </td>
                        <td class="p-3 border-b border-gray-700">
                            <button onclick="predictStudent('{{ student.id }}')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors duration-200">
                                Predict
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-400">
                Showing 1 to {{ students|length }} of {{ students|length }} entries
            </div>
            <div class="flex space-x-2">
                <button class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1 rounded-lg transition duration-300">
                    <i class="fas fa-angle-left"></i>
                </button>
                <button class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded-lg transition duration-300">
                    1
                </button>
                <button class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1 rounded-lg transition duration-300">
                    <i class="fas fa-angle-right"></i>
                </button>
            </div>
        </div>
        {% else %}
        <div class="bg-gray-700 rounded-lg p-8 text-center">
            <i class="fas fa-user-graduate text-4xl text-gray-500 mb-4"></i>
            <h4 class="text-gray-400 font-medium mb-2">No Student Data Available</h4>
            <p class="text-gray-500 mb-4">Add student data to begin performance analysis</p>
            <button class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-medium py-2 px-6 rounded-lg shadow-md transition-all duration-300">
                <i class="fas fa-plus mr-2"></i> Add Students
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global chart references
let comparisonChart;
let trendChart;
let matrixChart;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    initializeCharts();
    
    // Setup form submission
    setupPredictionForm();
    
    // Setup chart view toggle buttons
    setupChartViewToggle();
});

function initializeCharts() {
    // Performance Trend Chart
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
            datasets: [{
                label: 'Class Average',
                data: [65, 68, 70, 72, 75, 73],
                borderColor: '#818cf8',
                backgroundColor: 'rgba(129, 140, 248, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: getChartOptions('Performance Trends Over Time')
    });

    // Performance Matrix Chart
    const matrixCtx = document.getElementById('matrixChart').getContext('2d');
    matrixChart = new Chart(matrixCtx, {
        type: 'radar',
        data: {
            labels: ['Attendance', 'Assignments', 'Tests', 'Participation', 'Engagement'],
            datasets: [{
                label: 'Class Average',
                data: [75, 68, 72, 65, 70],
                borderColor: '#60a5fa',
                backgroundColor: 'rgba(96, 165, 250, 0.2)',
                borderWidth: 2
            }]
        },
        options: getRadarChartOptions('Performance Metrics')
    });
}

function setupPredictionForm() {
    const form = document.getElementById('predictionForm');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const studentId = formData.get('student_id');
        const studentName = document.getElementById('student_id').options[document.getElementById('student_id').selectedIndex].text;
        
        // Show loading state
        document.getElementById('predictionResultCard').classList.add('hidden');
        document.getElementById('comparisonChartContainer').classList.add('hidden');
        
        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                updatePredictionResult(data, studentName);
                updateComparisonChart(data);
                
                // Show results with animation
                document.getElementById('predictionResultCard').classList.remove('hidden');
                document.getElementById('comparisonChartContainer').classList.remove('hidden');
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while making the prediction');
        }
    });
}

function updatePredictionResult(data, studentName) {
    // Update student name
    document.getElementById('selectedStudentName').textContent = studentName;
    
    // Update predicted score with animation
    const predictedScore = data.predicted_score;
    document.getElementById('predictedScore').textContent = `${predictedScore}%`;
    
    // Animate progress bar
    const progressBar = document.getElementById('predictionProgress');
    progressBar.style.width = '0%';
    setTimeout(() => {
        progressBar.style.width = `${predictedScore}%`;
    }, 100);
    
    // Update accuracy
    document.getElementById('accuracyScore').textContent = `Accuracy: ${data.accuracy || 95}%`;
    
    // Update metric scores
    document.getElementById('attendanceScore').textContent = `${data.student.attendance}%`;
    document.getElementById('assignmentScore').textContent = `${data.student.assignments}%`;
    document.getElementById('testScore').textContent = `${data.student.test_scores}%`;
}

function updateComparisonChart(data) {
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (comparisonChart) {
        comparisonChart.destroy();
    }
    
    // Determine chart type based on active button
    const chartType = document.getElementById('radarViewBtn').classList.contains('bg-purple-700') ? 'radar' : 'bar';
    
    comparisonChart = new Chart(ctx, {
        type: chartType,
        data: {
            labels: ['Attendance', 'Assignments', 'Test Scores', 'Overall'],
            datasets: [
                {
                    label: 'Selected Student',
                    data: [
                        data.student.attendance,
                        data.student.assignments,
                        data.student.test_scores,
                        data.predicted_score
                    ],
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2
                },
                {
                    label: 'Class Average',
                    data: [
                        data.class_avg.attendance,
                        data.class_avg.assignments,
                        data.class_avg.test_scores,
                        data.class_avg.overall
                    ],
                    backgroundColor: 'rgba(139, 92, 246, 0.7)',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 2
                },
                {
                    label: 'Top Performer',
                    data: [
                        data.top_performer.attendance,
                        data.top_performer.assignments,
                        data.top_performer.test_scores,
                        data.top_performer.overall
                    ],
                    backgroundColor: 'rgba(34, 197, 94, 0.7)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 2
                }
            ]
        },
        options: chartType === 'radar' ? getRadarChartOptions('Performance Comparison') : getChartOptions('Performance Comparison')
    });
}

function setupChartViewToggle() {
    const radarBtn = document.getElementById('radarViewBtn');
    const barBtn = document.getElementById('barViewBtn');
    
    radarBtn.addEventListener('click', function() {
        if (!this.classList.contains('bg-purple-700')) {
            this.classList.remove('bg-gray-700');
            this.classList.add('bg-purple-700');
            barBtn.classList.remove('bg-purple-700');
            barBtn.classList.add('bg-gray-700');
            
            if (comparisonChart) {
                comparisonChart.destroy();
                const ctx = document.getElementById('comparisonChart').getContext('2d');
                
                comparisonChart = new Chart(ctx, {
                    type: 'radar',
                    data: comparisonChart.data,
                    options: getRadarChartOptions('Performance Comparison')
                });
            }
        }
    });
    
    barBtn.addEventListener('click', function() {
        if (!this.classList.contains('bg-purple-700')) {
            this.classList.remove('bg-gray-700');
            this.classList.add('bg-purple-700');
            radarBtn.classList.remove('bg-purple-700');
            radarBtn.classList.add('bg-gray-700');
            
            if (comparisonChart) {
                comparisonChart.destroy();
                const ctx = document.getElementById('comparisonChart').getContext('2d');
                
                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: comparisonChart.data,
                    options: getChartOptions('Performance Comparison')
                });
            }
        }
    });
}

function getChartOptions(title) {
    return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    color: '#e2e8f0',
                    font: {
                        family: 'Inter'
                    }
                }
            },
            title: {
                display: true,
                text: title,
                color: '#e2e8f0',
                font: {
                    size: 16
                }
            },
            tooltip: {
                backgroundColor: '#1e293b',
                titleColor: '#f8fafc',
                bodyColor: '#e2e8f0',
                borderColor: '#334155',
                borderWidth: 1,
                displayColors: true,
                intersect: false,
                mode: 'index'
            }
        },
        scales: {
            x: {
                grid: {
                    color: '#334155'
                },
                ticks: {
                    color: '#94a3b8'
                }
            },
            y: {
                grid: {
                    color: '#334155'
                },
                ticks: {
                    color: '#94a3b8',
                    callback: function(value) {
                        return value + '%';
                    }
                },
                min: 0,
                max: 100
            }
        },
        interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
        }
    };
}

function getRadarChartOptions(title) {
    return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    color: '#e2e8f0',
                    font: {
                        family: 'Inter'
                    }
                }
            },
            title: {
                display: true,
                text: title,
                color: '#e2e8f0',
                font: {
                    size: 16
                }
            },
            tooltip: {
                backgroundColor: '#1e293b',
                titleColor: '#f8fafc',
                bodyColor: '#e2e8f0',
                borderColor: '#334155',
                borderWidth: 1,
                displayColors: true
            }
        },
        scales: {
            r: {
                angleLines: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                pointLabels: {
                    color: '#e2e8f0'
                },
                ticks: {
                    color: '#94a3b8',
                    backdropColor: 'transparent',
                    callback: function(value) {
                        return value + '%';
                    }
                },
                min: 0,
                max: 100
            }
        }
    };
}

function predictStudent(studentId) {
    // Set the dropdown value
    document.getElementById('student_id').value = studentId;
    
    // Trigger form submission
    document.getElementById('predictionForm').dispatchEvent(new Event('submit'));
}

// Training Modal Functions
function showTrainingModal() {
    document.getElementById('trainingModal').classList.remove('hidden');
    document.getElementById('trainingModal').classList.add('flex');
    document.getElementById('trainingStatus').classList.remove('hidden');
    document.getElementById('completionStatus').classList.add('hidden');
}

function showCompletionStatus() {
    document.getElementById('trainingStatus').classList.add('hidden');
    document.getElementById('completionStatus').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('trainingModal').classList.add('hidden');
    document.getElementById('trainingModal').classList.remove('flex');
}

document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    showTrainingModal();
    
    let formData = new FormData(this);
    
    fetch("{% url 'dashboard:upload_data' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showCompletionStatus();
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            alert('Error: ' + data.message);
            closeModal();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        closeModal();
    });
});
</script>
{% endblock %}