{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Dashboard Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div>
            <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">Student Performance Dashboard</h2>
            <p class="text-gray-400">Analyze and predict student performance with AI-powered insights</p>
        </div>
        <div class="mt-4 md:mt-0 flex space-x-2">
            <button class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-download mr-2"></i> Export Data
            </button>
            <button class="bg-gradient-to-r from-purple-600 to-purple-800 hover:from-purple-700 hover:to-purple-900 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-cog mr-2"></i> Settings
            </button>
        </div>
    </div>

    <!-- Add this after the Dashboard Header -->
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 hover:border-green-500 transition-all duration-300 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-green-300">Upload Training Data</h3>
            <span class="text-sm text-gray-400">Supported format: .xlsx</span>
        </div>
        <form method="post" enctype="multipart/form-data" action="{% url 'dashboard:upload_data' %}" class="flex items-center space-x-4" id="uploadForm">
            {% csrf_token %}
            <div class="flex-1">
                <input type="file" 
                       name="excel_file" 
                       accept=".xlsx,.xls"
                       class="w-full p-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-green-500 focus:ring-2 focus:ring-green-800 transition-all duration-300"
                       required>
            </div>
            <button type="submit" id="uploadBtn"
                    class="bg-gradient-to-r from-green-600 to-green-800 hover:from-green-700 hover:to-green-900 text-white font-medium py-2 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center space-x-2">
                <i class="fas fa-upload"></i>
                <span>Upload & Train</span>
            </button>
        </form>
    </div>

    <!-- Training Status Modal -->
    <div id="trainingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 max-w-md w-full mx-4">
            <div id="trainingStatus" class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-green-500 border-t-transparent mb-4"></div>
                <h3 class="text-xl font-semibold text-white mb-2">Training Model</h3>
                <p class="text-gray-400">Please wait while the model is being trained...</p>
            </div>
            <div id="completionStatus" class="flex flex-col items-center hidden">
                <div class="text-green-500 text-5xl mb-4">âœ“</div>
                <h3 class="text-xl font-semibold text-white mb-2">Training Complete</h3>
                <p class="text-gray-400 mb-4">Model is now ready for predictions!</p>
                <button onclick="closeModal()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg transition duration-300">
                    Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Total Students Card -->
        <div class="bg-gradient-to-br from-blue-900 to-blue-800 p-6 rounded-xl shadow-lg border border-blue-800 hover:border-blue-500 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-blue-300 text-sm font-medium">Total Students</p>
                    <h3 class="text-2xl font-bold text-white mt-2">{{ students|length }}</h3>
                </div>
                <div class="bg-blue-700 p-3 rounded-lg">
                    <i class="fas fa-users text-blue-300"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm text-blue-300">
                <i class="fas fa-chart-bar mr-1"></i> Active Students
            </div>
        </div>

        <!-- Average Performance Card -->
        <div class="bg-gradient-to-br from-purple-900 to-purple-800 p-6 rounded-xl shadow-lg border border-purple-800 hover:border-purple-500 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-purple-300 text-sm font-medium">Class Performance</p>
                    <h3 class="text-2xl font-bold text-white mt-2">
                        {% if avg_performance %}{{ avg_performance|floatformat:1 }}%{% else %}0%{% endif %}
                    </h3>
                </div>
                <div class="bg-purple-700 p-3 rounded-lg">
                    <i class="fas fa-chart-line text-purple-300"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm text-purple-300">
                <i class="fas fa-arrow-{% if performance_trend == 'up' %}up text-green-400{% else %}down text-red-400{% endif %} mr-1"></i>
                {{ trend_percentage|default:0 }}% from last month
            </div>
        </div>

        <!-- At Risk Students Card -->
        <div class="bg-gradient-to-br from-red-900 to-red-800 p-6 rounded-xl shadow-lg border border-red-800 hover:border-red-500 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-red-300 text-sm font-medium">At Risk Students</p>
                    <h3 class="text-2xl font-bold text-white mt-2">{{ at_risk_count }}</h3>
                </div>
                <div class="bg-red-700 p-3 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-red-300"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm text-red-300">
                <i class="fas fa-user-shield mr-1"></i>
                Need Attention
            </div>
        </div>

        <!-- Average Attendance Card -->
        <div class="bg-gradient-to-br from-indigo-900 to-indigo-800 p-6 rounded-xl shadow-lg border border-indigo-800 hover:border-indigo-500 transition-all duration-300">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-indigo-300 text-sm font-medium">Class Attendance</p>
                    <h3 class="text-2xl font-bold text-white mt-2">
                        {% if avg_attendance %}{{ avg_attendance|floatformat:1 }}%{% else %}0%{% endif %}
                    </h3>
                </div>
                <div class="bg-indigo-700 p-3 rounded-lg">
                    <i class="fas fa-calendar-check text-indigo-300"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm text-indigo-300">
                <i class="fas fa-arrow-{% if attendance_trend == 'up' %}up text-green-400{% else %}down text-red-400{% endif %} mr-1"></i>
                {{ attendance_percentage|default:0 }}% from last month
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Prediction Form -->
        <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 hover:border-blue-500 transition-all duration-300">
            <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-300 mb-4">Performance Prediction</h3>
            <form method="post" action="{% url 'dashboard:predict' %}" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="student_id" class="block text-gray-400 mb-2">Select Student</label>
                    <select name="student_id" id="student_id" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-800 transition-all duration-300" required>
                        <option value="" disabled selected>Select a student</option>
                        {% for student in students %}
                        <option value="{{ student.id }}">{{ student.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="model_type" class="block text-gray-400 mb-2">Prediction Model</label>
                    <select name="model_type" id="model_type" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-800 transition-all duration-300">
                        <option value="random_forest">Random Forest (Default)</option>
                        <option value="neural_net">Neural Network</option>
                        <option value="gradient_boost">Gradient Boost</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-[1.02] flex items-center justify-center">
                    <i class="fas fa-chart-line mr-2"></i> Predict Performance
                </button>
            </form>
            
            <!-- Recent Predictions -->
            <div class="mt-6">
                <h4 class="text-gray-400 font-medium mb-3">Recent Predictions</h4>
                <div class="space-y-3">
                    {% for prediction in recent_predictions|slice:":3" %}
                    <div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="text-white font-medium">{{ prediction.student.name }}</p>
                            <p class="text-xs text-gray-400">{{ prediction.timestamp|date:"M d, Y H:i" }}</p>
                        </div>
                        <div class="bg-{% if prediction.score >= 75 %}green{% elif prediction.score >= 50 %}yellow{% else %}red{% endif %}-900 text-{% if prediction.score >= 75 %}green{% elif prediction.score >= 50 %}yellow{% else %}red{% endif %}-300 px-3 py-1 rounded-full text-sm font-bold">
                            {{ prediction.score|floatformat:0 }}%
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 text-sm">No recent predictions</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Performance Visualization -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Line Graph Performance Metrics -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-300 mb-4">Performance Trends</h3>
                <div class="h-72">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Performance Matrix -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-300 mb-4">Performance Matrix</h3>
                <div class="h-72">
                    <canvas id="matrixChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Table with Enhanced Features -->
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 hover:border-teal-500 transition-all duration-300">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-teal-300">Student Performance Data</h3>
            <div class="flex space-x-2">
                <div class="relative">
                    <input type="text" placeholder="Search students..." class="bg-gray-700 text-white pl-10 pr-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 w-64">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <button class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded-lg transition-all duration-300">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
        </div>
        
        {% if students %}
        <div class="overflow-x-auto">
            <table class="w-full text-left text-gray-400 border-collapse">
                <thead>
                    <tr class="bg-gray-700">
                        <th>Roll No</th>
                        <th>Name</th>
                        <th>Year</th>
                        <th>Participation</th>
                        <th>Assignments</th>
                        <th>Test Scores</th>
                        <th>Attendance</th>
                        <th>Final Grade</th>
                        <th>Predicted</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr class="hover:bg-gray-700 transition duration-300">
                        <td class="p-3 border-b border-gray-700">{{ student.roll_no }}</td>
                        <td class="p-3 border-b border-gray-700">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold mr-3">
                                    {{ student.name|first|upper }}
                                </div>
                                <span class="font-medium text-white">{{ student.name }}</span>
                            </div>
                        </td>
                        <td class="p-3 border-b border-gray-700">{{ student.year_of_study }}</td>
                        <td class="p-3 border-b border-gray-700">{{ student.participation }}%</td>
                        <td class="p-3 border-b border-gray-700">{{ student.assignments }}%</td>
                        <td class="p-3 border-b border-gray-700">{{ student.test_scores }}%</td>
                        <td class="p-3 border-b border-gray-700">
                            <div class="flex items-center">
                                <div class="w-16 bg-gray-600 rounded-full h-2 mr-2">
                                    <div class="bg-{% if student.attendance >= 80 %}green{% elif student.attendance >= 60 %}yellow{% else %}red{% endif %}-500 h-2 rounded-full" 
                                         style="width: {{ student.attendance }}%"></div>
                                </div>
                                {{ student.attendance }}%
                            </div>
                        </td>
                        <td class="p-3 border-b border-gray-700">
                            <span class="px-3 py-1 rounded-full text-sm font-bold 
                                {% if student.final_grade >= 75 %}bg-green-900 text-green-300
                                {% elif student.final_grade >= 60 %}bg-yellow-900 text-yellow-300
                                {% else %}bg-red-900 text-red-300{% endif %}">
                                {{ student.final_grade|floatformat:0 }}%
                            </span>
                        </td>
                        <td class="p-3 border-b border-gray-700">
                            <span class="px-3 py-1 rounded-full text-sm font-bold 
                                {% if student.performance_prediction >= 75 %}bg-green-900 text-green-300
                                {% elif student.performance_prediction >= 60 %}bg-yellow-900 text-yellow-300
                                {% else %}bg-red-900 text-red-300{% endif %}">
                                {{ student.performance_prediction|default:"N/A"|floatformat:0 }}%
                            </span>
                        </td>
                        <td class="p-3 border-b border-gray-700">
                            {% with risk_score=student.get_risk_score %}
                            <span class="px-3 py-1 rounded-full text-sm font-bold
                                {% if risk_score >= 75 %}bg-green-900 text-green-300
                                {% elif risk_score >= 60 %}bg-yellow-900 text-yellow-300
                                {% else %}bg-red-900 text-red-300{% endif %}">
                                {% if risk_score >= 75 %}Good Standing
                                {% elif risk_score >= 60 %}Needs Attention
                                {% else %}At Risk{% endif %}
                            </span>
                            {% endwith %}
                        </td>
                        <td class="p-3 border-b border-gray-700">
                            <button onclick="predictStudent('{{ student.id }}')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors duration-200">
                                Predict
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-400">
                Showing 1 to {{ students|length }} of {{ students|length }} entries
            </div>
            <div class="flex space-x-2">
                <button class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1 rounded-lg transition duration-300">
                    <i class="fas fa-angle-left"></i>
                </button>
                <button class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded-lg transition duration-300">
                    1
                </button>
                <button class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1 rounded-lg transition duration-300">
                    <i class="fas fa-angle-right"></i>
                </button>
            </div>
        </div>
        {% else %}
        <div class="bg-gray-700 rounded-lg p-8 text-center">
            <i class="fas fa-user-graduate text-4xl text-gray-500 mb-4"></i>
            <h4 class="text-gray-400 font-medium mb-2">No Student Data Available</h4>
            <p class="text-gray-500 mb-4">Add student data to begin performance analysis</p>
            <button class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-medium py-2 px-6 rounded-lg shadow-md transition-all duration-300">
                <i class="fas fa-plus mr-2"></i> Add Students
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Performance Chart
        const ctx = document.getElementById('performanceChart').getContext('2d');
        const performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
                datasets: [
                    {
                        label: 'Class Average',
                        data: [65, 68, 70, 72, 75, 73],
                        borderColor: '#818cf8',
                        backgroundColor: 'rgba(129, 140, 248, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Top 25%',
                        data: [80, 82, 85, 84, 88, 86],
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Bottom 25%',
                        data: [50, 52, 48, 45, 47, 50],
                        borderColor: '#f87171',
                        backgroundColor: 'rgba(248, 113, 113, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#e2e8f0',
                            font: {
                                family: 'Inter'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        titleColor: '#f8fafc',
                        bodyColor: '#e2e8f0',
                        borderColor: '#334155',
                        borderWidth: 1,
                        displayColors: true,
                        intersect: false,
                        mode: 'index'
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: '#334155'
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    },
                    y: {
                        grid: {
                            color: '#334155'
                        },
                        ticks: {
                            color: '#94a3b8',
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        min: 30,
                        max: 100
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        // Make table rows clickable
        document.querySelectorAll('tbody tr').forEach(row => {
            row.addEventListener('click', function() {
                // Here you would typically navigate to a detail view
                console.log('Navigating to student details for:', this.querySelector('td').textContent);
            });
        });

        // Add sort functionality to table headers
        document.querySelectorAll('th').forEach(header => {
            header.addEventListener('click', function() {
                // Here you would implement sorting logic
                console.log('Sorting by:', this.textContent.trim());
            });
        });
    });

    function showTrainingModal() {
        document.getElementById('trainingModal').classList.remove('hidden');
        document.getElementById('trainingModal').classList.add('flex');
        document.getElementById('trainingStatus').classList.remove('hidden');
        document.getElementById('completionStatus').classList.add('hidden');
    }

    function showCompletionStatus() {
        document.getElementById('trainingStatus').classList.add('hidden');
        document.getElementById('completionStatus').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('trainingModal').classList.add('hidden');
        document.getElementById('trainingModal').classList.remove('flex');
    }

    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        showTrainingModal();
        
        let formData = new FormData(this);
        
        fetch("{% url 'dashboard:upload_data' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showCompletionStatus();
                setTimeout(() => {
                    window.location.reload();  // Reload to show updated predictions
                }, 2000);
            } else {
                alert('Error: ' + data.message);
                closeModal();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            closeModal();
        });
    });

    // Individual vs Average Performance Chart
    const compCtx = document.getElementById('comparisonChart').getContext('2d');
    new Chart(compCtx, {
        type: 'radar',
        data: {
            labels: ['Participation', 'Assignments', 'Test Scores', 'Attendance'],
            datasets: [{
                label: 'Class Average',
                data: [
                    {{ avg_metrics.participation|floatformat:1 }},
                    {{ avg_metrics.assignments|floatformat:1 }},
                    {{ avg_metrics.test_scores|floatformat:1 }},
                    {{ avg_metrics.attendance|floatformat:1 }}
                ],
                backgroundColor: 'rgba(147, 51, 234, 0.2)',
                borderColor: 'rgb(147, 51, 234)',
                borderWidth: 2,
                pointBackgroundColor: 'rgb(147, 51, 234)'
            }]
        },
        options: {
            scales: {
                r: {
                    angleLines: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    pointLabels: {
                        color: '#e2e8f0'
                    },
                    ticks: {
                        color: '#94a3b8',
                        backdropColor: 'transparent'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#e2e8f0'
                    }
                }
            }
        }
    });

    // Performance by Year Chart
    const yearCtx = document.getElementById('yearChart').getContext('2d');
    new Chart(yearCtx, {
        type: 'bar',
        data: {
            labels: ['1st Year', '2nd Year', '3rd Year', '4th Year'],
            datasets: [{
                label: 'Average Performance',
                data: [
                    {{ performance_by_year.1|floatformat:1 }},
                    {{ performance_by_year.2|floatformat:1 }},
                    {{ performance_by_year.3|floatformat:1 }},
                    {{ performance_by_year.4|floatformat:1 }}
                ],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(249, 115, 22, 0.8)',
                    'rgba(139, 92, 246, 0.8)'
                ]
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#94a3b8'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#94a3b8'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Performance Distribution Chart
    const distCtx = document.getElementById('distributionChart').getContext('2d');
    new Chart(distCtx, {
        type: 'line',
        data: {
            labels: {{ student_names|safe }},
            datasets: [{
                label: 'Individual Performance',
                data: {{ student_performances|safe }},
                borderColor: 'rgb(16, 185, 129)',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(16, 185, 129, 0.1)'
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#94a3b8'
                    }
                },
                x: {
                    display: false
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#e2e8f0'
                    }
                }
            }
        }
    });

    // Real-time Performance Chart
    const realTimeCtx = document.getElementById('realTimeChart').getContext('2d');
    const realTimeChart = new Chart(realTimeCtx, {
        type: 'line',
        data: {
            labels: {{ student_names|safe }},
            datasets: [{
                label: 'Assignments',
                data: {{ performance_trends.assignments|safe }},
                borderColor: '#60A5FA',
                tension: 0.4
            }, {
                label: 'Test Scores',
                data: {{ performance_trends.test_scores|safe }},
                borderColor: '#34D399',
                tension: 0.4
            }, {
                label: 'Attendance',
                data: {{ performance_trends.attendance|safe }},
                borderColor: '#F472B6',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    labels: { color: '#E5E7EB' }
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: '#9CA3AF' }
                },
                x: {
                    display: false
                }
            }
        }
    });

    // Grade Distribution Chart
    const gradeCtx = document.getElementById('gradeChart').getContext('2d');
    new Chart(gradeCtx, {
        type: 'doughnut',
        data: {
            labels: ['A', 'B', 'C', 'D', 'F'],
            datasets: [{
                data: [
                    {{ grade_distribution.A }},
                    {{ grade_distribution.B }},
                    {{ grade_distribution.C }},
                    {{ grade_distribution.D }},
                    {{ grade_distribution.F }}
                ],
                backgroundColor: [
                    '#34D399', '#60A5FA', '#FBBF24', '#F472B6', '#EF4444'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { color: '#E5E7EB' }
                }
            }
        }
    });

    // Student Distribution by Year Chart
    const yearCtx = document.getElementById('yearDistributionChart').getContext('2d');
    new Chart(yearCtx, {
        type: 'bar',
        data: {
            labels: ['1st Year', '2nd Year', '3rd Year', '4th Year'],
            datasets: [{
                label: 'Number of Students',
                data: [
                    {{ student_count_by_year.1 }},
                    {{ student_count_by_year.2 }},
                    {{ student_count_by_year.3 }},
                    {{ student_count_by_year.4 }}
                ],
                backgroundColor: [
                    'rgba(96, 165, 250, 0.7)',
                    'rgba(52, 211, 153, 0.7)',
                    'rgba(244, 114, 182, 0.7)',
                    'rgba(251, 191, 36, 0.7)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: '#9CA3AF' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#9CA3AF' }
                }
            }
        }
    });

    // Function to update real-time metrics
    function updateMetrics() {
        fetch('/dashboard/metrics/')
            .then(response => response.json())
            .then(data => {
                realTimeChart.data.datasets.forEach((dataset, index) => {
                    dataset.data = data.metrics[index];
                });
                realTimeChart.update();
            });
    }

    // Update metrics every 30 seconds
    setInterval(updateMetrics, 30000);
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all charts
    initializeCharts();
    
    // Update real-time data every 5 seconds
    setInterval(updateCharts, 5000);
});

function initializeCharts() {
    // Real-time Performance Chart
    const realTimeCtx = document.getElementById('realTimeChart').getContext('2d');
    window.realTimeChart = new Chart(realTimeCtx, {
        type: 'line',
        data: {
            labels: {{ student_names|safe }},
            datasets: [{
                label: 'Assignments',
                data: {{ chart_data.weekly_performance.datasets.assignments|safe }},
                borderColor: '#60A5FA',
                tension: 0.4,
                fill: false
            }, {
                label: 'Test Scores',
                data: {{ chart_data.weekly_performance.datasets.test_scores|safe }},
                borderColor: '#34D399',
                tension: 0.4,
                fill: false
            }, {
                label: 'Attendance',
                data: {{ chart_data.weekly_performance.datasets.attendance|safe }},
                borderColor: '#F472B6',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: true,
                    labels: { color: '#E5E7EB' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: '#9CA3AF' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#9CA3AF' }
                }
            }
        }
    });

    // Grade Distribution Chart
    const gradeCtx = document.getElementById('gradeChart').getContext('2d');
    window.gradeChart = new Chart(gradeCtx, {
        type: 'doughnut',
        data: {
            labels: ['A', 'B', 'C', 'D', 'F'],
            datasets: [{
                data: [
                    {{ grade_distribution.A }},
                    {{ grade_distribution.B }},
                    {{ grade_distribution.C }},
                    {{ grade_distribution.D }},
                    {{ grade_distribution.F }}
                ],
                backgroundColor: [
                    '#34D399',
                    '#60A5FA',
                    '#FBBF24',
                    '#F472B6',
                    '#EF4444'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { color: '#E5E7EB' }
                }
            }
        }
    });
}

function updateCharts() {
    fetch('/dashboard/metrics/')
        .then(response => response.json())
        .then(data => {
            // Update real-time chart
            window.realTimeChart.data.datasets.forEach((dataset, index) => {
                dataset.data = data.metrics[Object.keys(data.metrics)[index]];
            });
            window.realTimeChart.update();

            // Update other charts as needed
            updateGradeDistribution(data.grade_distribution);
        })
        .catch(error => console.error('Error updating charts:', error));
}

function updateGradeDistribution(data) {
    if (window.gradeChart && data) {
        window.gradeChart.data.datasets[0].data = [
            data.A, data.B, data.C, data.D, data.F
        ];
        window.gradeChart.update();
    }
}

// Performance Trend Line Chart
const trendCtx = document.getElementById('trendChart').getContext('2d');
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: {{ student_names|safe }},
        datasets: [{
            label: 'Assignments',
            data: {{ performance_trends.assignments|safe }},
            borderColor: '#60A5FA',
            tension: 0.4
        }, {
            label: 'Test Scores',
            data: {{ performance_trends.test_scores|safe }},
            borderColor: '#34D399',
            tension: 0.4
        }, {
            label: 'Attendance',
            data: {{ performance_trends.attendance|safe }},
            borderColor: '#F472B6',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { intersect: false },
        plugins: {
            legend: { labels: { color: '#E5E7EB' } }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: '#9CA3AF' }
            },
            x: {
                display: false
            }
        }
    }
});

// Performance Matrix Chart
const matrixCtx = document.getElementById('matrixChart').getContext('2d');
new Chart(matrixCtx, {
    type: 'radar',
    data: {
        labels: {{ performance_matrix.metrics|safe }},
        datasets: [{
            label: 'Current Performance',
            data: {{ performance_matrix.current|safe }},
            borderColor: '#60A5FA',
            backgroundColor: 'rgba(96, 165, 250, 0.2)'
        }, {
            label: 'Target',
            data: {{ performance_matrix.target|safe }},
            borderColor: '#34D399',
            backgroundColor: 'rgba(52, 211, 153, 0.2)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            r: {
                angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                pointLabels: { color: '#E5E7EB' },
                ticks: { 
                    color: '#9CA3AF',
                    backdropColor: 'transparent'
                }
            }
        },
        plugins: {
            legend: {
                labels: { color: '#E5E7EB' }
            }
        }
    }
});

// Year Performance Chart
const yearPerformanceCtx = document.getElementById('yearPerformanceChart').getContext('2d');
new Chart(yearPerformanceCtx, {
    type: 'bar',
    data: {
        labels: {{ yearly_data.labels|safe }},
        datasets: [{
            label: 'Average Grade',
            data: {{ yearly_data.values|safe }},
            backgroundColor: [
                'rgba(129, 140, 248, 0.8)',
                'rgba(52, 211, 153, 0.8)',
                'rgba(249, 115, 22, 0.8)',
                'rgba(139, 92, 246, 0.8)'
            ],
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                    color: '#94a3b8',
                    callback: function(value) {
                        return value + '%';
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#94a3b8'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: '#1e293b',
                titleColor: '#f8fafc',
                bodyColor: '#e2e8f0',
                displayColors: false
            }
        }
    }
});

// Year Distribution Chart
const yearDistributionCtx = document.getElementById('yearDistributionChart').getContext('2d');
new Chart(yearDistributionCtx, {
    type: 'doughnut',
    data: {
        labels: {{ yearly_data.labels|safe }},
        datasets: [{
            data: {{ yearly_data.counts|safe }},
            backgroundColor: [
                'rgba(129, 140, 248, 0.8)',
                'rgba(52, 211, 153, 0.8)',
                'rgba(249, 115, 22, 0.8)',
                'rgba(139, 92, 246, 0.8)'
            ],
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    color: '#94a3b8',
                    padding: 20,
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: '#1e293b',
                titleColor: '#f8fafc',
                bodyColor: '#e2e8f0',
                displayColors: false
            }
        }
    }
});

// ...rest of existing chart code...
</script>
{% endblock %}